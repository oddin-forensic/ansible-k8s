---
- name: "Desabilitando swap"
  shell: swapoff -a
  become: true

- name: Commenting Swap entries in /etc/fstab
  replace:
    path: /etc/fstab
    regexp: '(.*swap*)'
    replace: '#\1'

- name: "Habilitando firewalld"
  service:
    name: firewalld
    state: started
    enabled: yes

- name: Allow Network Ports in Firewalld
  firewalld:
    port: "{{ item }}"
    state: enabled
    permanent: yes
    immediate: yes
  with_items: "{{ ports }}"

- name: Enabling Bridge Firewall Rule
  shell: "echo '1' > /proc/sys/net/bridge/bridge-nf-call-iptables"

- name: Enabling Bridge forward
  shell: "echo '1' > /proc/sys/net/ipv4/ip_forward"

- name: Creating a repository file for Kubernetes
  file:
    path: /etc/yum.repos.d/kubernetes.repo
    state: touch

- name: Adding repository details in Kubernetes repo file.
  blockinfile:
    path: /etc/yum.repos.d/kubernetes.repo
    block: |
      [kubernetes]
      name=Kubernetes
      baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
      enabled=1
      gpgcheck=0
      repo_gpgcheck=0
      gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg
       https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg

#- name: "Removendo dependencias"
#  yum:
#    name: "{{ item }}"
#    state: absent
#  with_items: 
#    - kubeadm
#    - kubectl
#    - kubelet
#  become: true

- name: "Instalando dependencias"
  yum:
    disable_gpg_check: true
    update_cache: yes
#    cache_valid_time: "3600"
    name: "{{ item }}"
  with_items: "{{ kubernetes_dependencies }}"
  become: true

- name: "Startando servi√ßos"
  service:
    name: "{{ item }}"
    state: started
    enabled: yes
  with_items: "{{ services }}"
